<link rel="import" href="view-element.html">
<link rel="import" href="travlendar-styles.html">
<dom-module id="add-calendar-view-element">
    <template>
        <style include="travlendar-styles"></style>
        <firebase-document id="document" app-name="travlendar" path="/events/[[user.uid]]/" data="{{newEvent}}">
        </firebase-document>
        <firebase-query id="query" app-name="travlendar" path="/events/[[user.uid]]" data="{{events}}">
        </firebase-query>
        <!--Output Panel-->
        <div class="outputPanel">
            <iron-input bind-value="{{newEvent.title}}">
                Title:
                <input value="{{value::input}}">
            </iron-input>
            <iron-input bind-value="{{newEvent.location}}">
                Location:
                <input value2="{{value2::input}}">
            </iron-input>
            <iron-input bind-value="{{newEvent.date}}">
                Date:
                <input value3="{{value3::input}}">
            </iron-input>
            <iron-input bind-value="{{newEvent.from}}">
                From:
                <input value4="{{value4::input}}">
            </iron-input>
            <iron-input bind-value="{{newEvent.to}}">
                To:
                <input value5="{{value5::input}}">
            </iron-input>
        </div>
        <!--Input Panel-->
        <div class="inputPanel">
            <!--Text Panel-->
            <div class="textPanel">
                Edit your calenda events here
            </div>
            <paper-menu>
                <paper-item on-click="checkEvent">Save Event</paper-item>
                <a href="#editCalendarView">
                    <paper-item>Cancel</paper-item>
                </a>
            </paper-menu>
        </div>
    </template>
    <script>
    class AddCalendarViewElement extends ViewElement {
        static get is() { return 'add-calendar-view-element'; }
        static get properties() {}
        constructor() {
            super();
        }
        ready() {
            super.ready();
        }

        saveEvent() {
            this.$.document.saveValue('/events/' + this.user.uid);
            //TODO empty input text
            this.$.document.reset().then(function() {
                window.location.href = '/#editCalendarView';
            });
        }

        checkEvent() {

            var feasible = false;
            var newEvent = this.$.document.data;
            var events = this.$.query.data;
            var currentDay = new Date(parseInt(newEvent.date));
            var currentEvents = [];
            for (var i = 0; i < events.length; i++) { //filter for the current day of the event added
                var d = new Date(parseInt(events[i].date));
                if (d.getDate() == currentDay.getDate()) {
                    currentEvents.push(events[i]);
                }
            }

            currentEvents.push(newEvent);
            currentEvents.sort(function(a, b) { return a.from - b.from }); //sort it.
            var position = currentEvents.indexOf(newEvent);
            var prev = currentEvents[position - 1]
            var curr = currentEvents[position];
            var next = currentEvents[position + 1];

            if (currentEvents.length > 1) {
                if (position == 0) { //inserted event has no predecessor
                    if (parseInt(curr.to) < parseInt(next.from)) {
                        feasible = this.computeDefaultRoute(curr, next)
                    } else {
                        alert("events overlapping"); 
                    }
                } else {
                    if (position == currentEvents.length - 1) { //inserted event has no successor
                        if (parseInt(prev.to) < parseInt(curr.from)) {
                            feasible = this.computeDefaultRoute(prev, curr)
                        } else {
                            alert("events overlapping");
                        }
                    } else { //inserted event is in the middle of two event
                        if ((parseInt(prev.to) < parseInt(curr.from)) && (parseInt(curr.to) < parseInt(next))) {
                            feasible = this.computeDefaultRoute(prev, curr);
                            feasible = this.computeDefaultRoute(curr, next);
                        } else {
                            alert("events overlapping");
                        }
                    }
                }
            }

            //check for break preferences.
            
            if (feasible) {
                this.saveEvent();
            } else {
                this.$.document.reset().then(function() {
                    window.location.href = '/#editCalendarView';
                });
            }
        }

        computeDefaultRoute(start, end) {
            var directionsService = new google.maps.DirectionsService();
            var request = {
                origin: start.location,
                destination: end.location,
                travelMode: 'TRANSIT',
                transitOptions: { //TODO check for GMT date because probably add +1 automatically
                    departureTime: new Date(parseInt(start.date) + parseInt(start.from) * 60 * 1000)
                }
            };
            directionsService.route(request, function(response, status) {
                if (status == 'OK') { // we have always one route and one leg in this case
                    var duration = response.routes[0].legs[0].duration.value / 60;
                    if (start.to + duration < end.from) {
                        return true;
                    } else {
                        alert("event NOT feasible");
                        return false;
                    }
                } else {
                    alert(status);
                    return false;
                }
            });
        }
    }

    customElements.define(AddCalendarViewElement.is, AddCalendarViewElement);
    </script>
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAoZU1vQtj2p_QUMsE1J5kWURi0G7U8Txw" async defer></script>
</dom-module>