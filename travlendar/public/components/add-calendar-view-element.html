<link rel="import" href="view-element.html">
<link rel="import" href="travlendar-styles.html">
<dom-module id="add-calendar-view-element">
    <template>
        <style include="travlendar-styles"></style>
        <firebase-document id="document" app-name="travlendar" path="/events/[[user.uid]]/" data="{{newEvent}}">
        </firebase-document>
        <template-view>
            <span slot="outputPanel">
                <iron-input bind-value="{{newEvent.title}}">
                Title:
                <input value="{{value::input}}">
                </iron-input>
                <iron-input bind-value="{{newEvent.location}}">
                    Location:
                    <input value2="{{value2::input}}">
                </iron-input>
                <iron-input bind-value="{{newEvent.date}}">
                    Date:
                    <input value3="{{value3::input}}">
                </iron-input>
                <iron-input bind-value="{{newEvent.from}}">
                    From:
                    <input value4="{{value4::input}}">
                </iron-input>
                <iron-input bind-value="{{newEvent.to}}">
                    To:<input value5="{{value5::input}}">
                </iron-input>
            </span>

            <span slot="textPanel">
                Choose data and press save
            </span>

            <span slot="inputPanel">
                <paper-icon-item class="menu-item" on-tap="saveEvent">
                    <iron-icon icon="add" slot="item-icon"></iron-icon>Save New Event
                </paper-icon-item>
                <paper-icon-item class="menu-item" onclick="window.location.href = '#editCalendarView'">
                    <iron-icon icon="myicons:arrow-back" slot="item-icon"></iron-icon>Cancel
                </paper-icon-item>
            </span>
        </template-view>
    </template>
    <script>
    class AddCalendarViewElement extends ViewElement {
        static get is() { return 'add-calendar-view-element'; }
        static get properties() {}
        constructor() {
            super();
        }
        ready() {
            super.ready();
        }
        saveEvent() {
            this.checkEvent()
            this.$.document.saveValue('/events/' + this.user.uid);
            //TODO empty input text
            this.$.document.reset().then(function() {
                window.location.href = '#editCalendarView';
            });
        }
        checkEvent() {
            var newEvent = this.$.document.data;
            var events = this.$.query.data;
            var currentDay = new Date(parseInt(newEvent.date));
            var currentEvents = [];
            for (var i = 0; i < events.length; i++) { //filter for the current day of the event added
                var d = new Date(parseInt(events[i].date));
                if (d.getDate() == currentDay.getDate()) {
                    currentEvents.push(events[i]);
                }
            }
            currentEvents.push(newEvent);
            currentEvents.sort(function(a, b) { return a.from - b.from }); //sort it.
            var position = currentEvents.indexOf(newEvent);
            if (currentEvents.length > 1) {
                if (position == 0) { //inserted event has no predecessor
                    if (parseInt(currentEvents[position].to) < parseInt(currentEvents[position + 1].from)) {
                        this.computeDefaultRoute(currentEvents[position].location, currentEvents[position + 1].location)
                    } else {
                        alert("events overlapping"); //TODO do not add if is unfeasible or overlapping
                    }
                } else {
                    if (position == currentEvents.length - 1) { //inserted event has no successor
                        if (parseInt(currentEvents[position - 1].to) < parseInt(currentEvents[position].from)) {
                            this.computeDefaultRoute(currentEvents[position - 1], currentEvents[position])
                        } else {
                            alert("events overlapping");
                        }
                    } else { //inserted event is in the middle of two event
                        if ((parseInt(currentEvents[position - 1].to) < parseInt(currentEvents[position].from)) && (parseInt(currentEvents[position].to) < parseInt(currentEvents[position + 1]))) {
                            this.computeDefaultRoute(currentEvents[position].location, currentEvents[position + 1].location)
                        } else {
                            alert("events overlapping");
                        }
                    }
                }
            }
            for (var i = 0; i < currentEvents.length; i++) {
                console.log(currentEvents[i].title + currentEvents[i].date);
            }
            //TODO check if is feasible
        }
        computeDefaultRoute(start, end) {
            var directionsService = new google.maps.DirectionsService();
            var request = {
                origin: start.location,
                destination: end.location,
                travelMode: 'TRANSIT',
                transitOptions: { //TODO check fro GMT date because probably add +1 automatically
                    departureTime: new Date(parseInt(start.date) + parseInt(start.from) * 60 * 1000)
                }
            };
            directionsService.route(request, function(response, status) {
                if (status == 'OK') { //TODO for each route and then for each legs
                    var duration = response.routes[0].legs[0].duration.value / 60;
                    if (start.to + duration < end.from) {
                        alert("event feasible")
                    } else {
                        alert("event NOT feasible");
                    }
                } else {
                    alert(status);
                }
            });
        }
    }
    customElements.define(AddCalendarViewElement.is, AddCalendarViewElement);
    </script>

    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAoZU1vQtj2p_QUMsE1J5kWURi0G7U8Txw" async defer></script>

</dom-module>