<html><head></head><body><dom-module id="compute-travel-view-element"><template><style include="travlendar-styles"></style><firebase-query id="query" app-name="travlendar" path="/currentProposal/[[user.uid]]" data="{{liveProposal}}"></firebase-query><firebase-query id="queryEvents" app-name="travlendar" path="/events/[[user.uid]]" data="{{events}}"></firebase-query><firebase-query id="queryPrefObject" app-name="travlendar" path="/preferences/[[user.uid]]" data="{{pref}}"></firebase-query><firebase-document id="document" app-name="travlendar" path="/currentProposal/[[user.uid]]" data="{{prop}}"></firebase-document><app-indexeddb-mirror session="[[user.uid]]" key="compute-proposal" data="{{liveProposal}}" persisted-data="{{proposal}}"></app-indexeddb-mirror><template-view><span slot="outputPanel"><travel-proposal-element current-proposal="[[proposal]]"></travel-proposal-element></span><span slot="textPanel"><span class="breadcrumbs">Home/ComputeTravelProposal</span> Here is you're current day travel proposal computed for you. You can compute another one if you prefer. </span><span slot="inputPanel"><paper-icon-item class="menu-item" on-tap="filterAndSortEvents"><iron-icon icon="card-travel" slot="item-icon"></iron-icon>Compute Different Travel</paper-icon-item><paper-icon-item class="menu-item" onclick="window.location.href = '#homeView'"><iron-icon icon="arrow-back" slot="item-icon"></iron-icon>Go Back</paper-icon-item></span></template-view></template><script>var travelPreferencesObject,currentEvents=[],numberOfApiCalls=0,currentTravelProposal=[];class ComputeTravelViewElement extends ViewElement{static get is(){return'compute-travel-view-element'}static get properties(){return{prop:{type:Object}}}constructor(){super()}ready(){super.ready(),window.addEventListener('api-return',(a)=>this.computeTravelPiece(a.detail.firstCall,a.detail.lastCall)),window.addEventListener('finished',()=>this.saveProposal())}filterAndSortEvents(){currentEvents=[],this.prop=[];for(var a,b=this.$.queryEvents.data,c=new Date,d=0;d<b.length;d++)if(a=new Date(parseInt(b[d].date)),a.getDate()==c.getDate()&&a.getMonth()==c.getMonth()&&a.getFullYear()==c.getFullYear()){var e={date:b[d].date,from:b[d].from,to:b[d].to,location:b[d].location,title:b[d].title};currentEvents.push(e)}currentEvents.sort(function(c,a){return c.from-a.from}),0==currentEvents.length?alert('no event today you are free'):this.queryDb()}queryDb(){travelPreferencesObject=this.$.queryPrefObject.data[1],numberOfApiCalls=0,this.computeTravelPiece(!0,!1)}computeTravelPiece(a,b){var c,d,e=[],f=!1;travelPreferencesObject.allow_bus&&e.push('BUS'),travelPreferencesObject.allow_subway&&e.push('SUBWAY'),travelPreferencesObject.allow_train&&e.push('TRAIN'),travelPreferencesObject.allow_tram&&e.push('TRAM');var g=[travelPreferencesObject.avoidHighways,travelPreferencesObject.avoidTolls];a?(c={date:currentEvents[0].date,location:travelPreferencesObject.home,from:0,to:0},d=currentEvents[0]):(d=b?{date:currentEvents[0].date,location:travelPreferencesObject.home,from:1440,to:1440}:currentEvents[1],c=currentEvents[0]);var h={arrivalTime:new Date(parseInt(d.date)+1e3*(60*parseInt(d.from))-3600000),modes:e};travelPreferencesObject.reduce_carbon_footprint?0===numberOfApiCalls?travelPreferencesObject.disable_walking?numberOfApiCalls++:(f=!0,this.apiCall(c,d,'WALKING',g,h,!1)):1===numberOfApiCalls?!travelPreferencesObject.bike_disabled&&(travelPreferencesObject.own_bike||travelPreferencesObject.allow_bike_sharing)?(f=!0,this.apiCall(c,d,'WALKING',g,h,!0)):numberOfApiCalls++:2===numberOfApiCalls?travelPreferencesObject.public_transport_disabled?numberOfApiCalls++:(f=!0,this.apiCall(c,d,'TRANSIT',g,h,!1)):3===numberOfApiCalls?!travelPreferencesObject.car_disabled&&(travelPreferencesObject.own_car||travelPreferencesObject.allow_car_sharing)?(f=!0,this.apiCall(c,d,'DRIVING',g,h,!1)):numberOfApiCalls++:void 0:0===numberOfApiCalls?!travelPreferencesObject.car_disabled&&(travelPreferencesObject.own_car||travelPreferencesObject.allow_car_sharing)?(f=!0,this.apiCall(c,d,'DRIVING',g,h,!1)):numberOfApiCalls++:1===numberOfApiCalls?travelPreferencesObject.public_transport_disabled?numberOfApiCalls++:(f=!0,this.apiCall(c,d,'TRANSIT',g,h,!1)):2===numberOfApiCalls?!travelPreferencesObject.bike_disabled&&(travelPreferencesObject.own_bike||travelPreferencesObject.allow_bike_sharing)?(f=!0,this.apiCall(c,d,'WALKING',g,h.true)):numberOfApiCalls++:3===numberOfApiCalls?travelPreferencesObject.disable_walking?numberOfApiCalls++:(f=!0,this.apiCall(c,d,'WALKING',g,h,!1)):void 0;4==numberOfApiCalls?(alert('no feasible schedule find with this preferences'),currentTravelProposal=[]):(0==currentEvents.length&&this.saveProposal(),!f&&this.computeTravelPiece(a,b))}apiCall(a,b,c,d,e,f){var g=new google.maps.DirectionsService,h={origin:a.location,destination:b.location,travelMode:c,transitOptions:e,avoidHighways:d[0],avoidTolls:d[1]};g.route(h,function(d,e){if(numberOfApiCalls++,'OK'==e){var g=d.routes[0].legs[0].duration.value/60;if(parseInt(a.to)+g<parseInt(b.from)){var h;f?(h=b.from-g/3,c='BICYCLING'):h=b.from-g;var i={by:c,from:a.location,at:h,isTravelProposal:!0};currentTravelProposal.push(i),b.location!=travelPreferencesObject.home&&currentTravelProposal.push(b),numberOfApiCalls=0,a.location!=travelPreferencesObject.home&&currentEvents.splice(0,1),console.log('travel Piece computed'),0==currentEvents?window.dispatchEvent(new CustomEvent('finished')):window.dispatchEvent(new CustomEvent('api-return',{detail:{firstCall:!1,lastCall:1==currentEvents.length}}))}else window.dispatchEvent(new CustomEvent('api-return',{detail:{firstCall:a.location==travelPreferencesObject.home,lastCall:b.location==travelPreferencesObject.home}}))}else'ZERO_RESULT'==e?window.dispatchEvent(new CustomEvent('api-return',{detail:{firstCall:a.location==travelPreferencesObject.home,lastCall:b.location==travelPreferencesObject.home}})):alert(e)})}saveProposal(){this.prop=currentTravelProposal,currentTravelProposal=[]}}customElements.define(ComputeTravelViewElement.is,ComputeTravelViewElement);</script></dom-module></body></html>