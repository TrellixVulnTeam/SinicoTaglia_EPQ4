<html><head><link rel="import" href="view-element.html"><link rel="import" href="travlendar-styles.html"><link rel="import" href="paper-date-input.html"><link rel="import" href="../bower_components/iron-form/iron-form.html"><link rel="import" href="../bower_components/paper-input-place/paper-input-place.html"><link rel="import" href="../bower_components/paper-time-input/paper-time-input.html"></head><body><dom-module id="add-calendar-view-element"><template><style include="travlendar-styles">#eventForm{max-width:500px;}.times{padding-top:5px;@apply --layout-flex;@apply --layout-horizontal;-webkit-justify-content:space-between;justify-content:space-between;}.formInput{padding:10px;}</style><firebase-document id="document" app-name="travlendar" path="/events/[[user.uid]]/" data="{{newEvent}}"></firebase-document><firebase-query id="query" app-name="travlendar" path="/events/[[user.uid]]" data="{{events}}"></firebase-query><firebase-query id="queryBreak" app-name="travlendar" path="/preferences/[[user.uid]]" data="{{prefBreak}}"></firebase-query><firebase-query id="queryTravel" app-name="travlendar" path="/preferences/[[user.uid]]" data="{{prefTravel}}"></firebase-query><template-view><span slot="outputPanel"><iron-form id="eventForm" class="outputCenter"><form method="get" action="/addEvent"><paper-input class="formInput" label="Title" max-length="100" required="" auto-validate="" error-message="insert a correct title (max 100 chars)" value="{{newEvent.title}}"></paper-input><paper-input-place class="formInput" id="locationInput" required="" auto-validate="" pattern=".*[^ ].*" value="{{val}}" hide-error="" place="{{place}}" api-key="[[mapsApiKey]]" label="Location"></paper-input-place><paper-date-input class="formInput" label="Date" type="date" required="" auto-validate="" error-message="insert a valid date" min="2017-01-01" value="{{eventDate}}"></paper-date-input><div class="times"><paper-time-input class="formInput" label="Starting Time" required="" auto-validate="" hour="0" min="0" am-pm="PM" value="{{startTime}}"></paper-time-input><paper-time-input class="formInput" label="End Time" required="" auto-validate="" hour="0" min="0" am-pm="PM" value="{{endTime}}"></paper-time-input></div></form></iron-form></span><span slot="textPanel"><span class="breadcrumbs">Home/Calendar/New</span> Choose the event details and then press save </span><span slot="inputPanel"><paper-icon-item class="menu-item" on-tap="filterAndSortEvents"><iron-icon icon="add" slot="item-icon"></iron-icon>Save New Event</paper-icon-item><paper-icon-item class="menu-item" onclick="window.location.href = '#editCalendarView'"><iron-icon icon="myicons:arrow-back" slot="item-icon"></iron-icon>Cancel</paper-icon-item></span></template-view></template><script>var prevToCurrDuration,currToNextDuration,currentEvents=[],numberOfApiCalls=0,targetNumberOfApiCalls=0;class AddCalendarViewElement extends Polymer.mixinBehaviors([Polymer.AppNetworkStatusBehavior],ViewElement){static get is(){return'add-calendar-view-element'}static get properties(){return{mapsApiKey:{type:String,value:'AIzaSyAoZU1vQtj2p_QUMsE1J5kWURi0G7U8Txw',readOnly:!0},val:{type:Object,notify:!0,observer:'_locationChanged'},startTime:{type:Object,notify:!0,value:'0:0 PM',observer:'_startTimeChanged'},endTime:{type:Object,notify:!0,value:'0:0 PM',observer:'_endTimeChanged'},eventDate:{type:Object,notify:!0,observer:'_dateChanged'}}}static get observers(){return['_locationChanged(val)']}_locationChanged(a){this.newEvent.location=a.search}_startTimeChanged(a){if(null!=a){var b=a.split(':'),c=b[1].split(' '),d=60*parseInt(b[0])+parseInt(c[0]);'PM'==c[1]&&(d+=720),this.newEvent.from=d}}_endTimeChanged(a){if(null!=a){var b=a.split(':'),c=b[1].split(' '),d=60*parseInt(b[0])+parseInt(c[0]);'PM'==c[1]&&(d+=720),this.newEvent.to=d}}_dateChanged(a){this.newEvent.date=Date.parse(a)}constructor(){super()}ready(){super.ready(),window.addEventListener('feasibility-time-checked',(a)=>this.checkEvent(a.detail.feasible,a.detail.firstCall)),window.addEventListener('duration-time-computed',()=>this.checkBreakPreferences())}filterAndSortEvents(){if(!this.online)return void alert('You are offline. Read-only operations allowed!');if(this.$.eventForm.validate()&&null!=this.newEvent.location){currentEvents=[];var a=this.$.document.data,b=this.$.query.data,c=new Date(parseInt(a.date)),e=new Date;if(c.getTime()<e.getTime()||a.from>a.to)alert('data inserted are not correct, please check date or time inserted');else{for(var f,d=0;d<b.length;d++)f=new Date(parseInt(b[d].date)),f.getDate()==c.getDate()&&currentEvents.push(b[d]);e=e.getTime()-1e3*(3600*e.getHours())-1e3*(60*e.getMinutes())-1e3*e.getSeconds()-e.getMilliseconds()+3600000,currentEvents.push(a),currentEvents.push({date:e,from:0,to:0,location:this.$.queryTravel.data[1].home,title:'fromHome'}),currentEvents.push({date:e,from:1440,to:1440,location:this.$.queryTravel.data[1].home,title:'toHome'}),currentEvents.sort(function(c,a){return c.from-a.from}),this.checkEvent(!0,!0)}}}checkEvent(a,b){var c=currentEvents.indexOf(this.$.document.data),d=currentEvents[c-1],e=currentEvents[c],f=currentEvents[c+1];b?(targetNumberOfApiCalls=0,numberOfApiCalls=0,parseInt(d.to)<parseInt(e.from)&&parseInt(e.to)<parseInt(f.from)?(targetNumberOfApiCalls=2,this.checkTimeFeasibility(d,e)):(a=!1,alert('events overlapping'))):numberOfApiCalls<targetNumberOfApiCalls?this.checkTimeFeasibility(e,f):a&&(numberOfApiCalls=0,this.checkBreakPreferences())}checkBreakPreferences(){var a=currentEvents.indexOf(this.$.document.data),b=currentEvents[a-1],c=currentEvents[a],d=currentEvents[a+1];switch(numberOfApiCalls){case 0:this.computeDuration(b,c);break;case 1:this.computeDuration(d,c);break;case 2:var e=this.$.queryBreak.data,f=parseInt(this.$.queryBreak.data[0].lowerBound),g=parseInt(this.$.queryBreak.data[0].upperBound),h=parseInt(this.$.queryBreak.data[0].minTime),i=parseInt(b.to),j=parseInt(b.from),k=parseInt(c.to),l=parseInt(c.from),m=parseInt(d.to),n=parseInt(d.from);k+currToNextDuration<f||l-prevToCurrDuration>g?this.saveEvent():l-(i+prevToCurrDuration)>h&&l-f>h?this.saveEvent():n-(k+currToNextDuration)>h&&g-k>h?this.saveEvent():alert('event not feasible with the break time preferences');}}checkTimeFeasibility(a,b){var c=new google.maps.DirectionsService,d={origin:a.location,destination:b.location,travelMode:'TRANSIT',transitOptions:{departureTime:new Date(parseInt(a.date)+1e3*(60*parseInt(a.to))-3600000)}};c.route(d,function(c,d){if(numberOfApiCalls++,'OK'==d){var e=c.routes[0].legs[0].duration.value/60;parseInt(a.to)+e<parseInt(b.from)?window.dispatchEvent(new CustomEvent('feasibility-time-checked',{detail:{feasible:!0,firstCall:!1}})):alert('event NOT feasible')}else alert(d)})}computeDuration(a,b){var c=new google.maps.DirectionsService,d={origin:a.location,destination:b.location,travelMode:'TRANSIT',transitOptions:{departureTime:new Date(parseInt(a.date)+1e3*(60*parseInt(a.to))-3600000)}};c.route(d,function(a,b){numberOfApiCalls++,'OK'==b?(1==numberOfApiCalls?prevToCurrDuration=a.routes[0].legs[0].duration.value/60:currToNextDuration=a.routes[0].legs[0].duration.value/60,window.dispatchEvent(new CustomEvent('duration-time-computed'))):alert(b)})}saveEvent(){this.$.document.saveValue('/events/'+this.user.uid),this.$.document.reset().then(function(){window.location.href='#editCalendarView'})}}customElements.define(AddCalendarViewElement.is,AddCalendarViewElement);</script></dom-module></body></html>